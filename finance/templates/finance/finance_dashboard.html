{% extends 'core/base.html' %}
{% load static %}

{% block title %}Finance Dashboard - IDEASOPHIA{% endblock %}

{% block extra_css %}
<style>
.dashboard-container {
    padding: 6rem 0 3rem;
    min-height: 100vh;
}

.dashboard-header {
    text-align: center;
    margin-bottom: 3rem;
}

.dashboard-header h1 {
    color: var(--accent);
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.month-filter {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin: 2rem 0;
}

.month-filter input[type="month"] {
    padding: 0.75rem;
    background: rgba(55, 167, 73, 0.1);
    border: 2px solid var(--accent);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 1rem;
    font-family: 'Source Code Pro', monospace;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: linear-gradient(135deg, rgba(55, 167, 73, 0.1) 0%, rgba(44, 124, 65, 0.1) 100%);
    border: 2px solid rgba(55, 167, 73, 0.3);
    border-radius: 15px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(55, 167, 73, 0.2);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0.5rem;
}

.stat-value {
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 700;
}

.stat-value.positive {
    color: #37a749;
}

.stat-value.negative {
    color: #ef4444;
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.chart-card {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 15px;
    padding: 2rem;
}

.chart-card h3 {
    color: var(--accent);
    margin-bottom: 1.5rem;
    text-align: center;
}

.canvas-container {
    position: relative;
    height: 300px;
}

.transactions-section {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 15px;
    padding: 2rem;
}

.transactions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.transactions-header h3 {
    color: var(--accent);
}

.transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(55, 167, 73, 0.05);
    border-radius: 10px;
    margin-bottom: 1rem;
    transition: all 0.3s;
}

.transaction-item:hover {
    background: rgba(55, 167, 73, 0.1);
    transform: translateX(5px);
}

.transaction-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.transaction-icon {
    font-size: 2rem;
}

.transaction-details h4 {
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.transaction-details p {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.transaction-amount {
    font-size: 1.25rem;
    font-weight: 700;
}

.transaction-amount.income {
    color: #37a749;
}

.transaction-amount.expense {
    color: #ef4444;
}

.quick-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.action-btn {
    padding: 1rem 2rem;
    background: var(--accent);
    color: var(--bg-primary);
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
    font-family: 'Source Code Pro', monospace;
}

.action-btn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(55, 167, 73, 0.3);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.empty-state .icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

@media (max-width: 768px) {
    .charts-container {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .transaction-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <div class="dashboard-header">
            <h1>üí∞ Finance Dashboard</h1>
            <p style="color: var(--text-secondary);">Kelola keuangan Anda dengan bijak</p>
        </div>

        <!-- Month Filter -->
        <div class="month-filter">
            <label style="color: var(--text-primary);">Filter Bulan:</label>
            <input type="month" id="monthFilter" value="{{ current_month|date:'Y-m' }}" 
                   onchange="window.location.href='?month=' + this.value">
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-label">Total Pemasukan</div>
                <div class="stat-value positive">Rp {{ income_total|floatformat:0 }}</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìâ</div>
                <div class="stat-label">Total Pengeluaran</div>
                <div class="stat-value negative">Rp {{ expense_total|floatformat:0 }}</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üíµ</div>
                <div class="stat-label">Saldo</div>
                <div class="stat-value {% if balance >= 0 %}positive{% else %}negative{% endif %}">
                    Rp {{ balance|floatformat:0 }}
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>üìä Grafik Mingguan</h3>
                <div class="canvas-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>ü•ß Pengeluaran per Kategori</h3>
                <div class="canvas-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="transactions-section">
            <div class="transactions-header">
                <h3>üìù Transaksi Terbaru</h3>
                <a href="{% url 'finance:transactions' %}" class="action-btn">Lihat Semua</a>
            </div>

            {% if recent_transactions %}
                {% for transaction in recent_transactions %}
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-icon">
                            {% if transaction.type == 'income' %}üí∞{% else %}üí∏{% endif %}
                        </div>
                        <div class="transaction-details">
                            <h4>{{ transaction.category.name|default:"Tanpa Kategori" }}</h4>
                            <p>{{ transaction.date|date:"d M Y" }} - {{ transaction.description|truncatewords:10|default:"Tidak ada deskripsi" }}</p>
                        </div>
                    </div>
                    <div class="transaction-amount {{ transaction.type }}">
                        {% if transaction.type == 'income' %}+{% else %}-{% endif %}
                        Rp {{ transaction.amount|floatformat:0 }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="icon">üì≠</div>
                    <p>Belum ada transaksi bulan ini</p>
                </div>
            {% endif %}
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="{% url 'finance:add_transaction' %}" class="action-btn">‚ûï Tambah Transaksi</a>
            <a href="{% url 'finance:research_menu' %}" class="action-btn">üî¨ Menu Riset</a>
            <a href="{% url 'finance:transactions' %}" class="action-btn">üìã Semua Transaksi</a>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Weekly Chart
const weeksData = {{ weeks_data|safe }};
const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
new Chart(weeklyCtx, {
    type: 'bar',
    data: {
        labels: weeksData.map(w => w.week),
        datasets: [{
            label: 'Pemasukan',
            data: weeksData.map(w => w.income),
            backgroundColor: 'rgba(55, 167, 73, 0.7)',
            borderColor: 'rgba(55, 167, 73, 1)',
            borderWidth: 1
        }, {
            label: 'Pengeluaran',
            data: weeksData.map(w => w.expense),
            backgroundColor: 'rgba(239, 68, 68, 0.7)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: { 
                    color: '#83c441',
                    callback: function(value) {
                        return 'Rp ' + value.toLocaleString('id-ID');
                    }
                },
                grid: {
                    color: 'rgba(131, 196, 65, 0.1)'
                }
            },
            x: {
                ticks: { color: '#83c441' },
                grid: {
                    color: 'rgba(131, 196, 65, 0.1)'
                }
            }
        },
        plugins: {
            legend: {
                labels: { 
                    color: '#f4f6d2',
                    font: {
                        family: 'Source Code Pro'
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': Rp ' + context.parsed.y.toLocaleString('id-ID');
                    }
                }
            }
        }
    }
});

// Category Pie Chart
const categoryData = {{ category_data|safe }};
const categoryCtx = document.getElementById('categoryChart').getContext('2d');

if (categoryData.length > 0) {
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(c => c.name),
            datasets: [{
                data: categoryData.map(c => c.value),
                backgroundColor: categoryData.map(c => c.color),
                borderColor: '#231f20',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { 
                        color: '#f4f6d2',
                        font: {
                            family: 'Source Code Pro'
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': Rp ' + value.toLocaleString('id-ID') + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
} else {
    // Jika tidak ada data, tampilkan pesan
    categoryCtx.canvas.parentElement.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><p>Belum ada data pengeluaran</p></div>';
}
</script>
{% endblock %}